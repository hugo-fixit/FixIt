{{- /*
  Renders an interactive file tree structure from filesystem, page resources, data files, or inline content.
  See https://fixit.lruihao.cn/documentation/content-management/shortcodes/extended/filetree/
  [todo] To link files, add a `linkPrefix` param for the URL prefix, PRs welcome.

  @param {string} [path="/"] - The path relative to the root of your project directory (filesystem mode).
  @param {int} [level=1] - The expand level of the tree. Set to -1/0 to expand/collapse all levels.
  @param {boolean} [folderSlash=false] - Whether to append a trailing "/" to folder names.
  @param {string} [file] - The path to a data file in the page resources (page resource mode). Supports JSON, YAML, and TOML formats.
  @param {string} [data] - The name of the data file in data/filetree/ directory (data mode). Supports JSON, YAML, and TOML formats.
  @param {string} [ignoreList=""] - List of file or folder names to ignore, separated by commas.

  Priority order (highest to lowest):
  1. Inline content mode (.Inner content) - Parse tree data from shortcode body
  2. Page resource mode (file parameter) - Read data file from page bundle
  3. Data mode (data parameter) - Load data file from data/filetree/ directory
  4. Filesystem mode (path parameter) - Scan actual directory structure (default)

  Fallback mechanism: If the current mode fails (e.g., file not found, invalid format), 
  the shortcode will automatically fall back to the next available mode in the priority order.

  @example
  {{< file-tree "content" 2 />}}
  {{< file-tree path="content" level=2 folderSlash=true />}}
  {{< file-tree file="data/example.yml" />}}
  {{< file-tree data="example" />}}
  {{< file-tree >}}
  - name: my-project
    type: dir
    children:
      - name: src
        type: dir
      - name: package.json
        type: file
  {{< /file-tree >}}

  Data format note: YAML and JSON support direct array format, while TOML requires a root key 'filetree' due to format limitations.
  Example TOML structure:
  ```toml
  [[filetree]]
  name = "src"
  type = "dir"

  [[filetree.children]]
  name = "index.ts"
  type = "file"

  [[filetree]]
  name = "README.md"
  type = "file"
  ```
*/ -}}

{{- $config := dict | merge .Page.Params.filetree | merge .Site.Params.filetree -}}
{{- $root := cond .IsNamedParams (.Get "path") (.Get 0) | default "/" -}}
{{- $level := cond .IsNamedParams (.Get "level") (.Get 1) | default $config.level | default 1 -}}
{{- $folderSlash := .Get "folderSlash" | default $config.folderslash | default false -}}
{{- $fileName := .Get "file" -}}
{{- $dataName := .Get "data" -}}
{{- $treeData := slice -}}
{{- $supportExts := slice ".yml" ".yaml" ".json" ".toml" -}}
{{- $ignoreList :=
  (apply (split (.Get "ignoreList" | default "") ",") "trim" "." " ") | union
  $config.ignorelist | union
  (slice ".DS_Store" "Thumbs.db")
-}}

{{- /* Page resource mode: read file from page bundle */ -}}
{{- $fileContent := strings.TrimSpace .Inner | default "" -}}
{{- if $fileName | and (eq $fileContent "") -}}
  {{- $ext := path.Ext $fileName | lower -}}
  {{- if in $supportExts $ext -}}
    {{- with dict "Path" $fileName "Resources" $.Page.Resources | partial "function/resource.html" }}
      {{- $fileContent = .Content -}}
    {{- else -}}
      {{- warnidf "warning-file-tree" "[file-tree]: no such data file: %s" $fileName -}}
    {{- end -}}
  {{- else -}}
    {{- warnidf "warning-file-tree" "[file-tree]: Unsupported file format '%s'. Use %s. See %s %s" $ext (delimit $supportExts ", " " or ") $.Name $.Position -}}
  {{- end -}}
{{- end -}}

{{- /* Parse file content if available */ -}}
{{- with $fileContent -}}
  {{- $treeData = . | unmarshal -}}
  {{- if reflect.IsMap $treeData -}}
    {{- $treeData = $treeData.filetree -}}
  {{- end -}}
{{- end -}}

{{- /* Data mode: render tree from data files */ -}}
{{- if $dataName | and (eq (len $treeData) 0) -}}
  {{- with index .Site.Data.filetree (printf "%v.%v" $dataName .Page.Language) | default (index .Site.Data.filetree $dataName) -}}
    {{- $treeData = . -}}
  {{- else -}}
    {{- $exts := delimit (apply $supportExts "trim" "." "\\.") "|" -}}
    {{- warnidf "warning-file-tree" "[file-tree]: Data file 'data/filetree/%s.{%s}' not found. See %s %s" $dataName $exts $.Name $.Position -}}
  {{- end -}}
{{- end -}}

{{- /* Render data tree if available */ -}}
{{- if $treeData -}}
  <div class="file-tree-wrapper">
    {{- $options := dict
      "items" $treeData
      "depth" 0
      "level" $level
      "folderSlash" $folderSlash
      "ignoreList" $ignoreList
    -}}
    {{- template "render-data-tree" $options -}}
  </div>

{{- /* Filesystem mode: scan directory structure */ -}}
{{- else -}}
  {{- $rootIsExists := false -}}
  {{- $rootLabel := "" -}}
  {{- if fileExists $root -}}
    {{- $rootIsExists = true -}}
    {{- $f := os.Stat $root -}}
    {{- /* Attempt to resolve the path relative to the contentDir */ -}}
    {{- with try (readDir $root) -}}
      {{- with .Err }}
        {{- $root = path.Clean (path.Join "content" $root) -}}
      {{- end -}}
    {{- end -}}
    {{- /* Determine the root name for display */ -}}
    {{- $rootLabel = path.Clean $root -}}
    {{- if (eq $rootLabel "/") | or (eq $rootLabel ".") -}}
      {{- $rootLabel = $f.Name -}}
    {{- end -}}
    {{- $rootLabel = cond $folderSlash (add $rootLabel "/") $rootLabel -}}
  {{- else -}}
    {{- warnidf "warning-file-tree" "[file-tree]: The root path does not exist: %s.See %s %s" $root .Name .Position -}}
  {{- end -}}

  {{- /* Start rendering the file tree */ -}}
  {{- if $rootIsExists -}}
    <div class="file-tree-wrapper">
      <ul class="file-tree" data-level="0">
        <li class="file-tree-item file-tree-folder{{ if eq (int $level) 0 }} is-collapsed{{ end }}">
          <span class="file-tree-label file-tree-toggle">
            {{- dict "Class" "file-tree-icon fa-regular fa-folder-open" | partial "plugin/icon.html" -}}
            <span class="file-tree-label__inner">{{ $rootLabel }}</span>
          </span>
          {{- $options := dict
            "path" $root
            "depth" 1
            "level" $level
            "ignoreList" $ignoreList
            "folderSlash" $folderSlash
          -}}
          {{- template "render-tree" $options -}}
        </li>
      </ul>
    </div>
  {{- end -}}
{{- end -}}

{{- /*
  Recursive function to render tree from structured data
  @param {array} items - Array of tree items
  @param {int} depth - Current depth level
  @param {int} level - Collapse level
  @param {bool} folderSlash - Whether to append a trailing "/" to folder names
  @param {array} ignoreList - List of file or folder names to ignore
*/ -}}
{{- define "render-data-tree" -}}
  {{- $items := .items -}}
  {{- $depth := .depth -}}
  {{- $level := .level -}}
  {{- $folderSlash := .folderSlash -}}
  {{- $ignoreList := .ignoreList -}}

  <ul class="file-tree" data-level="{{ $depth }}">
    {{- range $items -}}
      {{- if in $ignoreList .name -}}
        {{- continue -}}
      {{- end -}}
      {{- $isDir := eq .type "dir" -}}
      {{- $isCollapsed := (ge $depth $level) | and (ge $level 0) -}}
      {{- $label := .name -}}
      {{- if and $isDir $folderSlash -}}
        {{- $label = printf "%s/" $label -}}
      {{- end -}}
      
      <li class="file-tree-item{{ if $isDir }} file-tree-folder{{ end }}{{ if and $isDir $isCollapsed }} is-collapsed{{ end }}">
        <span class="file-tree-label{{ if $isDir }} file-tree-toggle{{ end }}">
          {{- $icon := "file-tree-icon fa-regular " -}}
          {{- if $isDir -}}
            {{- $icon = add $icon "fa-folder-open" -}}
          {{- else -}}
            {{- $icon = add $icon "fa-file-lines" -}}
          {{- end -}}
          {{- dict "Class" $icon | partial "plugin/icon.html" -}}
          <span class="file-tree-label__inner">{{ $label }}</span>
        </span>
        
        {{- if and $isDir .children -}}
          {{- $options := dict
            "items" .children
            "depth" (add $depth 1)
            "level" $level
            "folderSlash" $folderSlash
            "ignoreList" $ignoreList
          -}}
          {{- template "render-data-tree" $options -}}
        {{- end -}}
      </li>
    {{- end -}}
  </ul>
{{- end -}}

{{- /*
  Recursive function to render tree from filesystem
  @param {string} path - Current directory path
  @param {int} depth - Current depth level
  @param {int} level - Collapse level
  @param {array} ignoreList - List of file or folder names to ignore
  @param {bool} folderSlash - Whether to append a trailing "/" to folder names
*/ -}}
{{- define "render-tree" -}}
  {{- $path := .path -}}
  {{- $depth := .depth -}}
  {{- $level := .level -}}
  {{- $folderSlash := .folderSlash -}}
  {{- $ignoreList := .ignoreList -}}
  {{- $items := readDir $path -}}

  <ul class="file-tree" data-level="{{ $depth }}">
    {{- range $items -}}
      {{- if in $ignoreList .Name -}}
        {{- continue -}}
      {{- end -}}
      {{- $fullPath := printf "%s/%s" $path .Name -}}
      {{- $isCollapsed := (ge $depth $level) | and (ge $level 0) -}}
      {{- $label := cond (and .IsDir $folderSlash) (add .Name "/") .Name -}}
      
      <li class="file-tree-item{{ if .IsDir }} file-tree-folder{{ end }}{{ if and .IsDir $isCollapsed }} is-collapsed{{ end }}">
        <span class="file-tree-label{{ if .IsDir }} file-tree-toggle{{ end }}">
          {{- $icon := "file-tree-icon fa-regular " -}}
          {{- if .IsDir -}}
            {{- $icon = add $icon "fa-folder-open" -}}
          {{- else -}}
            {{- $icon = add $icon "fa-file-lines" -}}
          {{- end -}}
          {{- dict "Class" $icon | partial "plugin/icon.html" -}}
          <span class="file-tree-label__inner">{{ $label }}</span>
        </span>
        
        {{- if .IsDir -}}
          {{- $options := dict
            "path" $fullPath
            "depth" (add $depth 1)
            "level" $level
            "ignoreList" $ignoreList
            "folderSlash" $folderSlash
          -}}
          {{- template "render-tree" $options -}}
        {{- end -}}
      </li>
    {{- end -}}
  </ul>
{{- end -}}
