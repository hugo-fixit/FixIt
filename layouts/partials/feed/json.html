{{- $pages := .Pages -}}
{{- /* Front matter: password */ -}}
{{- $pages = where $pages "Params.password" "eq" nil -}}
{{- /* Front matter: hiddenFromFeed */ -}}
{{- $pages = where $pages "Params.hiddenFromFeed" "ne" true -}}
{{- $limit := .Site.Params.feed.limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- $length := $pages.Len -}}
{{- /* 支持 image 属性 */ -}}

{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "{{ .Title }}",
  "description": "{{ .Site.Params.description | default .Site.Title }}",
  "home_page_url": "{{ .Site.BaseURL }}",
  {{ with .OutputFormats.Get "feed" -}}
  "feed_url": "{{ .Permalink }}",
  {{ end -}}
  {{ with .Site.Language.LanguageCode -}}
  "language": "{{ . }}",
  {{ end -}}
  "icon": "{{ `/apple-touch-icon.png` | absURL }}",
  "favicon": "{{ `/favicon.ico` | absURL }}",
  {{ with .Site.Params.author.name -}}
  "authors": [
    {
      "name": "{{ . }}"{{ with $.Site.Params.author.link }},
      "url": "{{ . }}"{{ end }}{{ with $.Site.Params.author.avatar }},
      "avatar": "{{ . | absURL }}"{{ end }}
    }
  ],
  {{ end -}}
  "items": [
    {{ range $index, $element := $pages -}}
    {{- $fullText := (.Param "feed").fullText -}}
    {{- $author := partial "function/get-author-map.html" .Params.author -}}
    {
      "title": {{ .Title | jsonify }},
      "date_published": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}",
      "date_modified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
      "id": "{{ .Permalink }}",
      "url": "{{ .Permalink }}",
      {{ with $author.name -}}
      "authors": [
        {
          "name": "{{ . }}"{{ with $author.link }},
          "url": "{{ . }}"{{ end }}{{ with $author.avatar }},
          "avatar": "{{ . | absURL }}"{{ end }}
        }
      ],
      {{ end -}}
      {{ with .Params.tags -}}
      "tags": {{ . | jsonify }},
      {{ end -}}
      {{ with .Summary -}}
      "summary": {{ . | plainify | jsonify }},
      {{ if not $fullText -}}
      "content_html": {{ . | plainify | jsonify }}
      {{- end }}
      {{- end -}}
      {{- if $fullText -}}
      "content_html": {{ .Content | jsonify }}
      {{- end }}
    }{{ if ne (add $index 1) $pages.Len }},
    {{ end }}
    {{- end }}
  ]
}
