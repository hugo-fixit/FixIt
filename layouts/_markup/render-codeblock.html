{{- $codeblock := .Attributes | merge (.Page.Param "codeblock") -}}
{{- $result := transform.HighlightCodeBlock . -}}
{{- $wrapper := $result.Wrapped -}}

{{- if $codeblock.wrapped -}}
  {{- $mode := $codeblock.mode | default "normal" -}}
  {{- $codeArr := slice -}}
  {{- with .Inner -}}
    {{- $codeArr = split . "\n" -}}
  {{- end -}}

  {{- if eq $mode "normal" -}}
    {{- $wrapper = partial "code-wrapper/normal.html" (dict "Wrapper" $wrapper "Opts" $codeblock "Type" .Type) -}}
  {{- end -}}

  {{- $wrapper = replace $wrapper `class="highlight"` (printf `class="highlight" data-mode="%s"` $mode) -}}
  {{- $wrapper = replace $wrapper `class="highlight"` (printf `class="highlight" data-len="%d"` (len $codeArr)) -}}
  {{- $wrapper = replace $wrapper `class="highlight"` `class="code-block highlight"` -}}
{{- end -}}

{{- $wrapper | safeHTML -}}
